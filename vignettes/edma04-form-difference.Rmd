---
title: "EDMA form difference matrix"
author: "Peter Solymos"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EDMA form difference matrix}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(429)
```

Form difference (FDM) is calculated as the ratio of form matrices
(FM) from the numerator and denominator objects following
Lele and Richtsmeier (1992, 1995): FDM(A,B) = FM(B)/FM(A).
Form matrices are formed as pairwise Euclidean distances
between landmarks from EDMA fit objects using the estimated mean forms.

Bootstrap distribution is based on fixing the
reference FM and taking the ration between the reference FM
and the bootstrap FMs from the other object.
The `ref_denom` argument can be used to control which object
is the reference:

```{r}
library(EDMAinR)

file1 <- system.file("extdata/crouzon/Crouzon_P0_Global_MUT.xyz",
    package="EDMAinR")
x1 <- read_xyz(file1)

file2 <- system.file("extdata/crouzon/Crouzon_P0_Global_NON-MUT.xyz",
    package="EDMAinR")
x2 <- read_xyz(file2)

numerator <- edma_fit(x1)
denominator <- edma_fit(x2)

fdm <- edma_fdm(numerator, denominator, B=25)
fdm
```

Here is how to do the global T-test: the T-statistic is based on the pairwise distanced in the FM,
taking the max/min.

```{r fig.width=7,fig.height=5,out.width='100%'}
T_test(fdm)
plot_Ttest(fdm)
```

The local CI base test is done via the stacked FDM 
and the confidence intervals (landmark labels get really busy):

```{r}
head(get_fdm(fdm))
head(get_fdm(fdm, sort=TRUE, decreasing=TRUE))
head(get_fdm(fdm, sort=TRUE, decreasing=FALSE))
```

```{r fig.width=7,fig.height=7,out.width='100%'}
plot_ci(fdm)
```

Influential landmarks are identified by leaving one landmark out,
then comparing the T-statistic with the value based on all the
landmarks. The existing bootstrap distribution of
the mean form is used (i.e. no re-estimation of the mean form):

```{r fig.width=7,fig.height=5,out.width='100%'}
head(infl <- get_influence(fdm))
plot(infl)
```

The ordination and cluster dendrogram shows the two sets
of specimens from the 2 objects:

```{r fig.width=7,fig.height=7,out.width='100%'}
plot_ord(fdm)
```

```{r fig.width=7,fig.height=7,out.width='100%'}
plot_clust(fdm)
```

The 2D and 3D plots produces a plot of the mean form
from the reference object ('prototype').
Influential landmarks are colored red.
Lines represent distances between landmarks,
<1 differences are colored blue, >1 differences are colored red.

```{r fig.width=7,fig.height=5,out.width='100%'}
plot_2d(fdm)
```


```{r fig.width=7,fig.height=5,out.width='100%'}
library(rgl)
plot_3d(fdm)
rglwidget(width = 600, height = 600, reuse = FALSE)
```
